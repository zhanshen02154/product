# 微服务架构演进实践——商品服务决策记录

## 解决Consul.Watch超时问题
### 日期
2025年11月6日
### 状态
已采纳
### 背景
订单服务出现大量consul健康检查错误的日志，过程主要出在consul.watch，而且请求Consul的API后面带有index参数，经判断为阻塞查询。
### 解决方案
设置Consul全局的超时时间为85s，API接口客户端WaitTime为60s，确保全局超时时间大于WaitTime。
#### 采纳理由
WaitTime等待时间小于全局超时时间就不会报错，不设置则默认5分钟远大于原定的超时时间30s，故配置为85s。

## 优化健康检查
### 日期
2025年11月4日
### 状态
已采纳
### 背景
旧版服务健康检查探针不够完善，只是单独开启Goroutine启动健康检查探针服务，要改成平滑退出。
### 方案A
用context.WithCancel在收到关闭信号后关闭goroutine。
#### 优点
- 使用context精确控制探针服务。
#### 风险
- 由于健康检查探针服务需要使用channel接收系统信号会和go micro框架底层冲突。
### 方案B
使用协程配合sync.WaitGroup控制服务启停，对服务注入BeforeStop函数，在停止服务之前关闭健康检查服务。
#### 优点
- 无需控制复杂的context，直接采用框架自带的方法处理，避免和框架的生命周期管理冲突。
#### 风险
- 无
### 最终方案：方案B
#### 采纳理由
- 不和框架底层冲突，实现复杂度低。

---

## 调整目录结构
### 日期
2025年10月31日
### 状态
已采纳
### 背景
原项目方案仅有领域层且排列较为杂乱耦合较高，需要让每层可插拔符合领域驱动架构分层的目标。
### 解决方案
保留领域层，增加应用层、配置、基础设施层，将基础设施分为缓存、客户端、持久化、注册中心共4个包，区分应用层的service和领域层的service，前者用于编排，后者实现具体业务逻辑。
#### 采纳理由
- 将每层做成可插拔的组件提高扩展性，符合领域驱动架构的要求。
- 精简无用的代码，移除私有仓库依赖。
#### 风险及应对措施
- 首版必须对所有功能做完整地测试。
- 涉及频繁转换结构体但可使用对象池避免频繁创建和销毁临时对象。
